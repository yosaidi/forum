<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forum</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
            cursor: pointer;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-links button, .nav-links a {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .nav-links button:hover, .nav-links a:hover {
            background-color: #f8f9fa;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        /* Main Content */
        .main {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .sidebar h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .category-list {
            list-style: none;
        }

        .category-list li {
            margin-bottom: 0.5rem;
        }

        .category-list button {
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .category-list button:hover,
        .category-list button.active {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .content {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        /* Forms */
        .form {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Post Cards */
        .post-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .post-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 1.5rem;
            background: white;
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        .post-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .post-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .post-meta {
            display: flex;
            gap: 1rem;
            color: #666;
            font-size: 0.875rem;
        }

        .post-content {
            color: #555;
            margin: 1rem 0;
        }

        .post-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .vote-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .vote-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .vote-btn:hover {
            background-color: #f8f9fa;
        }

        .vote-btn.active.like {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .vote-btn.active.dislike {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        /* Comments */
        .comments-section {
            margin-top: 2rem;
            border-top: 1px solid #eee;
            padding-top: 2rem;
        }

        .comment {
            border-left: 3px solid #007bff;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .comment-author {
            font-weight: 500;
            color: #007bff;
        }

        .comment-date {
            color: #666;
            font-size: 0.875rem;
        }

        .comment-content {
            color: #555;
            margin-bottom: 0.5rem;
        }

        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:hover:not(:disabled) {
            background-color: #f8f9fa;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .sidebar {
                order: 2;
            }

            .nav {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* Hide sections by default */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav container">
            <div class="logo" onclick="app.showHome()">Forum</div>
            <div class="nav-links">
                <div id="guest-nav" class="guest-nav">
                    <button onclick="app.showLogin()">Login</button>
                    <button onclick="app.showRegister()">Register</button>
                </div>
                <div id="user-nav" class="user-nav" style="display: none;">
                    <button onclick="app.showCreatePost()">New Post</button>
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar"></div>
                        <span id="username"></span>
                        <button onclick="app.logout()">Logout</button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3>Categories</h3>
            <ul class="category-list" id="categories">
                <li><button class="active" onclick="app.filterByCategory(null)">All Posts</button></li>
            </ul>
        </aside>

        <!-- Content Area -->
        <div class="content">
            <!-- Home/Posts List -->
            <section id="home-section" class="section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2>Latest Posts</h2>
                    <select id="sort-select" onchange="app.changeSorting(this.value)">
                        <option value="newest">Newest</option>
                        <option value="oldest">Oldest</option>
                        <option value="popular">Popular</option>
                    </select>
                </div>
                <div id="posts-loading" class="loading">Loading posts...</div>
                <div id="posts-list" class="post-list"></div>
                <div id="pagination" class="pagination"></div>
            </section>

            <!-- Single Post View -->
            <section id="post-section" class="section">
                <button onclick="app.showHome()" class="btn btn-secondary btn-small" style="margin-bottom: 1rem;">← Back to Posts</button>
                <div id="single-post"></div>
                <div id="comments-section" class="comments-section">
                    <h3>Comments</h3>
                    <div id="comment-form" style="display: none;">
                        <form onsubmit="app.submitComment(event)">
                            <div class="form-group">
                                <textarea id="comment-content" placeholder="Write a comment..." rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary btn-small">Post Comment</button>
                        </form>
                    </div>
                    <div id="comments-list"></div>
                </div>
            </section>

            <!-- Login Form -->
            <section id="login-section" class="section">
                <div class="form">
                    <h2 style="margin-bottom: 2rem; text-align: center;">Login</h2>
                    <form onsubmit="app.login(event)">
                        <div class="form-group">
                            <label>Username or Email</label>
                            <input type="text" id="login-username" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                        </div>
                        <p style="text-align: center;">
                            Don't have an account? <a href="#" onclick="app.showRegister()">Register</a>
                        </p>
                    </form>
                </div>
            </section>

            <!-- Register Form -->
            <section id="register-section" class="section">
                <div class="form">
                    <h2 style="margin-bottom: 2rem; text-align: center;">Register</h2>
                    <form onsubmit="app.register(event)">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="register-username" required>
                            <div class="form-error" id="username-error"></div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="register-email" required>
                            <div class="form-error" id="email-error"></div>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="register-password" required>
                            <div class="form-error" id="password-error"></div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
                        </div>
                        <p style="text-align: center;">
                            Already have an account? <a href="#" onclick="app.showLogin()">Login</a>
                        </p>
                    </form>
                </div>
            </section>

            <!-- Create Post Form -->
            <section id="create-post-section" class="section">
                <div class="form">
                    <h2 style="margin-bottom: 2rem; text-align: center;">Create New Post</h2>
                    <form onsubmit="app.createPost(event)">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="post-title" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="post-category" required>
                                <option value="">Select a category</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Content</label>
                            <textarea id="post-content" rows="10" required></textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Create Post</button>
                            <button type="button" onclick="app.showHome()" class="btn btn-secondary">Cancel</button>
                        </div>
                    </form>
                </div>
            </section>
        </div>
    </main>

    <!-- Message Area -->
    <div id="message-area"></div>

    <script>
        // API Configuration
        const API_BASE = '/api';

        // Application State
        const state = {
            user: null,
            posts: [],
            currentPost: null,
            categories: [],
            comments: [],
            currentPage: 1,
            currentCategory: null,
            currentSort: 'newest'
        };

        // API Helper Functions
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                credentials: 'include',
                ...options
            };

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || data.message || 'Request failed');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Authentication Functions
        async function checkAuthStatus() {
            try {
                const response = await apiRequest('/auth/me');
                if (response.success) {
                    state.user = response.data;
                    updateNavigation();
                    return true;
                }
            } catch (error) {
                state.user = null;
            }
            updateNavigation();
            return false;
        }

        function updateNavigation() {
            const guestNav = document.getElementById('guest-nav');
            const userNav = document.getElementById('user-nav');
            const username = document.getElementById('username');
            const avatar = document.getElementById('user-avatar');

            if (state.user) {
                guestNav.style.display = 'none';
                userNav.style.display = 'flex';
                username.textContent = state.user.username;
                avatar.textContent = state.user.username.charAt(0).toUpperCase();
            } else {
                guestNav.style.display = 'flex';
                userNav.style.display = 'none';
            }
        }

        // Main Application Object
        const app = {
            // Navigation
            showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');
            },

            showHome() {
                this.showSection('home-section');
                this.loadPosts();
            },

            showLogin() {
                this.showSection('login-section');
            },

            showRegister() {
                this.showSection('register-section');
            },

            showCreatePost() {
                if (!state.user) {
                    this.showMessage('Please login to create a post', 'error');
                    this.showLogin();
                    return;
                }
                this.showSection('create-post-section');
                this.loadCategoriesForForm();
            },

            showPost(postId) {
                this.showSection('post-section');
                this.loadSinglePost(postId);
            },

            // Authentication
            async login(event) {
                event.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;

                try {
                    const response = await apiRequest('/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({ username, password })
                    });

                    if (response.success) {
                        state.user = response.data.user;
                        this.showMessage('Login successful!', 'success');
                        updateNavigation();
                        this.showHome();
                    }
                } catch (error) {
                    this.showMessage(error.message, 'error');
                }
            },

            async register(event) {
                event.preventDefault();
                const username = document.getElementById('register-username').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;

                try {
                    const response = await apiRequest('/auth/register', {
                        method: 'POST',
                        body: JSON.stringify({ username, email, password })
                    });

                    if (response.success) {
                        state.user = response.data.user;
                        this.showMessage('Registration successful!', 'success');
                        updateNavigation();
                        this.showHome();
                    }
                } catch (error) {
                    this.showMessage(error.message, 'error');
                }
            },

            async logout() {
                try {
                    await apiRequest('/auth/logout', { method: 'POST' });
                    state.user = null;
                    updateNavigation();
                    this.showMessage('Logged out successfully', 'success');
                    this.showHome();
                } catch (error) {
                    this.showMessage(error.message, 'error');
                }
            },

            // Posts
            async loadPosts(page = 1) {
                try {
                    document.getElementById('posts-loading').style.display = 'block';
                    
                    const params = new URLSearchParams({
                        page: page,
                        limit: 10,
                        sort: state.currentSort
                    });
                    
                    if (state.currentCategory) {
                        params.append('category', state.currentCategory);
                    }

                    const response = await apiRequest(`/posts?${params}`);
                    
                    if (response.success) {
                        state.posts = response.data;
                        state.currentPage = page;
                        this.renderPosts();
                        this.renderPagination(response.pagination);
                    }
                } catch (error) {
                    this.showMessage(error.message, 'error');
                } finally {
                    document.getElementById('posts-loading').style.display = 'none';
                }
            },

            renderPosts() {
                const container = document.getElementById('posts-list');
                
                if (!state.posts || state.posts.length === 0) {
                    container.innerHTML = '<p>No posts found.</p>';
                    return;
                }

                container.innerHTML = state.posts.map(post => `
                    <div class="post-card" onclick="app.showPost(${post.id})">
                        <div class="post-header">
                            <div>
                                <h3 class="post-title">${this.escapeHtml(post.title)}</h3>
                                <div class="post-meta">
                                    <span>by ${this.escapeHtml(post.author.username)}</span>
                                    <span>•</span>
                                    <span>${post.category}</span>
                                    <span>•</span>
                                    <span>${this.formatDate(post.created_at)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="post-content">
                            ${this.truncateText(this.escapeHtml(post.content), 200)}
                        </div>
                        <div class="post-actions" onclick="event.stopPropagation()">
                            <div class="vote-buttons">
                                <button class="vote-btn ${post.user_vote === 'like' ? 'active like' : ''}" 
                                        onclick="app.votePost(${post.id}, 'like')">
                                    👍 ${post.like_count}
                                </button>
                                <button class="vote-btn ${post.user_vote === 'dislike' ? 'active dislike' : ''}" 
                                        onclick="app.votePost(${post.id}, 'dislike')">
                                    👎 ${post.dislike_count}
                                </button>
                            </div>
                            <span>💬 ${post.comment_count} comments</span>
                        </div>
                    </div>
                `).join('');
            },

            async loadSinglePost(postId) {
                try {
                    const response = await apiRequest(`/posts/${postId}`);
                    
                    if (response.success) {
                        state.currentPost = response.data;
                        this.renderSinglePost();
                        this.loadComments(postId);
                    }
                } catch (error) {
                    this.showMessage(error.message, 'error');
                }
            },

            renderSinglePost() {
                const container = document.getElementById('single-post');
                const post = state.currentPost;
                
                container.innerHTML = `
                    <div class="post-card">
                        <h1 class="post-title">${this.escapeHtml(post.title)}</h1>
                        <div class="post-meta">
                            <span>by ${this.escapeHtml(post.author.username)}</span>
                            <span>•</span>
                            <span>${post.category}</span>
                            <span>•</span>
                            <span>${this.formatDate(post.created_at)}</span>
                        </div>
                        <div class="post-content" style="margin: 2rem 0; white-space: pre-wrap;">
                            ${this.escapeHtml(post.content)}
                        </div>
                        <div class="post-actions">
                            <div class="vote-buttons">
                                <button class="vote-btn ${post.user_vote === 'like' ? 'active like' : ''}" 
                                        onclick="app.votePost(${post.id}, 'like')">
                                    👍 ${post.like_count}
                                </button>
                                <button class="vote-btn ${post.user_vote === 'dislike' ? 'active dislike' : ''}" 
                                        onclick="app.votePost(${post.id}, 'dislike')">
                                    👎 ${post.dislike_count}
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Show comment form if logged in
                const commentForm = document.getElementById('comment-form');
                if (state.user) {
                    commentForm.style.display = 'block';
                } else {
                    commentForm.style.display = 'none';
                }
            },

            async createPost(event) {
                event.preventDefault();
                
                if (!state.user) {
                    this.showMessage('Please login to create a post', 'error');
                    return;
                }

                const title = document.getElementById('post-title').value;
                const content = document.getElementById('post-content').value;
                const categoryId = parseInt(document.getElementById('post-category').value);

                try {
                    const response = await apiRequest('/posts', {
                        method: 'POST',
                        body: JSON.stringify({
                            title,
                            content,
                            category_id: categoryId
                        })
                    });

                    if (response.success) {
                        this.showMessage('Post created successfully!', 'success');
                        document.getElementById('post-title').value = '';
                        document.getElementById('post-content').value = '';
                        document.getElementById('post-category').value = '';
                        this.showHome();
                    }
                } catch (error) {
                    this.showMessage(error.message, 'error');
                }
            },

            // Voting
            async votePost(postId, voteType) {
                if (!state.user) {
                    this.showMessage('Please login to vote', 'error');
                    this.showLogin();
                    return;
                }

                try {
                    const response = await apiRequest(`/posts/${postId}/vote`, {
                        method: 'POST',
                        body: JSON.stringify({ vote_type: voteType })
                    });

                    if (response.success) {
                        // Update the vote counts in the current view
                        if (state.currentPost && state.currentPost.id === postId) {
                            state.currentPost.like_count = response.data.like_count;
                            state.currentPost.dislike_count = response.data.dislike_count;
                            state.currentPost.user_vote = response.data.action === 'removed' ? null : voteType;
                            this.renderSinglePost();
                        } else {
                            // Update in posts list
                            const post = state.posts.find(p => p.id === postId);
                            if (post) {
                                post.like_count = response.data.like_count;
                                post.dislike_count = response.data.dislike_count;
                                post.user_vote = response.data.action === 'removed' ? null : voteType;
                                this.renderPosts();
                            }
                        }
                    }
                } catch (error) {
                    this.showMessage(error.message, 'error');
                }
            },

            async voteComment(commentId, voteType) {
                if (!state.user) {
                    this.showMessage('Please login to vote', 'error');
                    return;
                }

                try {
                    const response = await apiRequest(`/comments/${commentId}/vote`, {
                        method: 'POST',
                        body: JSON.stringify({ vote_type: voteType })
                    });

                    if (response.success) {
                        // Reload comments to update vote counts
                        this.loadComments(state.currentPost.id);
                    }
                } catch (error) {
                    this.showMessage(error.message, 'error');
                }
            },

            // Comments
            async loadComments(postId) {
                try {
                    const response = await apiRequest(`/posts/${postId}/comments`);
                    
                    if (response.success) {
                        state.comments = response.data;
                        this.renderComments();
                    }
                } catch (error) {
                    this.showMessage(error.message, 'error');
                }
            },

            renderComments() {
                const container = document.getElementById('comments-list');
                
                if (!state.comments || state.comments.length === 0) {
                    container.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
                    return;
                }

                container.innerHTML = state.comments.map(comment => `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${this.escapeHtml(comment.author.username)}</span>
                            <span class="comment-date">${this.formatDate(comment.created_at)}</span>
                        </div>
                        <div class="comment-content">${this.escapeHtml(comment.content)}</div>
                        <div class="post-actions">
                            <div class="vote-buttons">
                                <button class="vote-btn ${comment.user_vote === 'like' ? 'active like' : ''}" 
                                        onclick="app.voteComment(${comment.id}, 'like')">
                                    👍 ${comment.likes || 0}
                                </button>
                                <button class="vote-btn ${comment.user_vote === 'dislike' ? 'active dislike' : ''}" 
                                        onclick="app.voteComment(${comment.id}, 'dislike')">
                                    👎 ${comment.dislikes || 0}
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            async submitComment(event) {
                event.preventDefault();
                
                if (!state.user) {
                    this.showMessage('Please login to comment', 'error');
                    return;
                }

                const content = document.getElementById('comment-content').value;
                
                if (!content.trim()) {
                    this.showMessage('Comment cannot be empty', 'error');
                    return;
                }

                try {
                    const response = await apiRequest('/comments', {
                        method: 'POST',
                        body: JSON.stringify({
                            content: content,
                            post_id: state.currentPost.id
                        })
                    });

                    if (response.success) {
                        document.getElementById('comment-content').value = '';
                        this.loadComments(state.currentPost.id);
                        this.showMessage('Comment added successfully!', 'success');
                    }
                } catch (error) {
                    this.showMessage(error.message, 'error');
                }
            },

            // Categories
            async loadCategories() {
                try {
                    // Since your backend doesn't seem to have a categories endpoint,
                    // we'll use the posts endpoint to extract categories
                    const response = await apiRequest('/posts?limit=100');
                    
                    if (response.success) {
                        const categories = [...new Set(response.data.map(post => post.category))];
                        state.categories = categories.map((cat, index) => ({ id: index + 1, name: cat }));
                        this.renderCategories();
                    }
                } catch (error) {
                    console.error('Failed to load categories:', error);
                }
            },

            renderCategories() {
                const container = document.getElementById('categories');
                const allButton = container.querySelector('li button');
                
                // Clear existing categories (except "All Posts")
                const existingCategories = container.querySelectorAll('li:not(:first-child)');
                existingCategories.forEach(li => li.remove());

                // Add category buttons
                state.categories.forEach(category => {
                    const li = document.createElement('li');
                    li.innerHTML = `<button onclick="app.filterByCategory('${category.name}')">${category.name}</button>`;
                    container.appendChild(li);
                });
            },

            async loadCategoriesForForm() {
                try {
                    const select = document.getElementById('post-category');
                    select.innerHTML = '<option value="">Select a category</option>';
                    
                    // Add some default categories for now
                    const defaultCategories = [
                        { id: 1, name: 'General' },
                        { id: 2, name: 'Technology' },
                        { id: 3, name: 'Sports' },
                        { id: 4, name: 'Entertainment' },
                        { id: 5, name: 'Science' }
                    ];
                    
                    defaultCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error('Failed to load categories for form:', error);
                }
            },

            // Filtering and Sorting
            filterByCategory(categoryName) {
                state.currentCategory = categoryName;
                state.currentPage = 1;
                
                // Update active category button
                document.querySelectorAll('.category-list button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                event.target.classList.add('active');
                
                this.loadPosts(1);
            },

            changeSorting(sortBy) {
                state.currentSort = sortBy;
                state.currentPage = 1;
                this.loadPosts(1);
            },

            // Pagination
            renderPagination(pagination) {
                const container = document.getElementById('pagination');
                
                if (!pagination || pagination.total_pages <= 1) {
                    container.innerHTML = '';
                    return;
                }

                let html = '';
                
                // Previous button
                html += `<button ${!pagination.has_prev ? 'disabled' : ''} 
                               onclick="app.loadPosts(${pagination.current_page - 1})">Previous</button>`;
                
                // Page numbers
                const startPage = Math.max(1, pagination.current_page - 2);
                const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
                
                if (startPage > 1) {
                    html += `<button onclick="app.loadPosts(1)">1</button>`;
                    if (startPage > 2) html += '<span>...</span>';
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    html += `<button class="${i === pagination.current_page ? 'active' : ''}" 
                                   onclick="app.loadPosts(${i})">${i}</button>`;
                }
                
                if (endPage < pagination.total_pages) {
                    if (endPage < pagination.total_pages - 1) html += '<span>...</span>';
                    html += `<button onclick="app.loadPosts(${pagination.total_pages})">${pagination.total_pages}</button>`;
                }
                
                // Next button
                html += `<button ${!pagination.has_next ? 'disabled' : ''} 
                               onclick="app.loadPosts(${pagination.current_page + 1})">Next</button>`;
                
                container.innerHTML = html;
            },

            // Utility Functions
            showMessage(message, type = 'info') {
                const messageArea = document.getElementById('message-area');
                const messageDiv = document.createElement('div');
                messageDiv.className = type;
                messageDiv.textContent = message;
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 1rem 2rem;
                    border-radius: 4px;
                    z-index: 3000;
                    max-width: 400px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                `;
                
                messageArea.appendChild(messageDiv);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 5000);
            },

            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            },

            truncateText(text, maxLength) {
                if (text.length <= maxLength) return text;
                return text.substr(0, maxLength) + '...';
            },

            formatDate(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffInHours = (now - date) / (1000 * 60 * 60);
                
                if (diffInHours < 1) {
                    return `${Math.floor(diffInHours * 60)} minutes ago`;
                } else if (diffInHours < 24) {
                    return `${Math.floor(diffInHours)} hours ago`;
                } else if (diffInHours < 24 * 7) {
                    return `${Math.floor(diffInHours / 24)} days ago`;
                } else {
                    return date.toLocaleDateString();
                }
            },

            // Initialize Application
            async init() {
                // Check authentication status
                await checkAuthStatus();
                
                // Load initial data
                this.loadPosts();
                this.loadCategories();
                
                // Set up event listeners
                window.addEventListener('popstate', () => {
                    // Handle browser back/forward buttons
                    this.showHome();
                });
            }
        };

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

        // Handle keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'k':
                        e.preventDefault();
                        document.querySelector('#login-username, #register-username')?.focus();
                        break;
                    case 'n':
                        e.preventDefault();
                        if (state.user) {
                            app.showCreatePost();
                        }
                        break;
                }
            }
        });

        // Export app for debugging in console
        window.app = app;
    </script>
</body>
</html>